"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.generateUBL = void 0;
var escapeXml = function (unsafe) {
    if (typeof unsafe !== 'string')
        return unsafe;
    return unsafe.replace(/[<>&'"]/g, function (c) {
        switch (c) {
            case '<': return '&lt;';
            case '>': return '&gt;';
            case '&': return '&amp;';
            case '\'': return '&apos;';
            case '"': return '&quot;';
            default: return c;
        }
    });
};
var generateUBL = function (invoice, erpCode, supplierVkn) {
    var uuid = crypto.randomUUID();
    var issueDate = new Date().toISOString().split('T')[0];
    var issueTime = new Date().toLocaleTimeString('tr-TR', { hour12: false });
    var profileId = invoice.profileId || (invoice.docType === 'EARSIV' ? 'EARSIVFATURA' : 'TICARIFATURA');
    // Basit UBL 2.1 Şablonu
    return "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Invoice xmlns=\"urn:oasis:names:specification:ubl:schema:xsd:Invoice-2\"\n xmlns:cac=\"urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2\"\n xmlns:cbc=\"urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2\"\n xmlns:ext=\"urn:oasis:names:specification:ubl:schema:xsd:CommonExtensionComponents-2\"\n xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n xsi:schemaLocation=\"urn:oasis:names:specification:ubl:schema:xsd:Invoice-2 UBL-Invoice-2.1.xsd\">\n    <ext:UBLExtensions>\n        <ext:UBLExtension>\n            <ext:ExtensionContent/>\n        </ext:UBLExtension>\n    </ext:UBLExtensions>\n    <cbc:UBLVersionID>2.1</cbc:UBLVersionID>\n    <cbc:CustomizationID>TR1.2</cbc:CustomizationID>\n    <cbc:ProfileID>".concat(profileId, "</cbc:ProfileID>\n    <cbc:ID>").concat(invoice.invoiceNumber || 'TASLAK-' + uuid.substring(0, 8), "</cbc:ID>\n    <cbc:CopyIndicator>false</cbc:CopyIndicator>\n    <cbc:UUID>").concat(uuid, "</cbc:UUID>\n    <cbc:IssueDate>").concat(issueDate, "</cbc:IssueDate>\n    <cbc:IssueTime>").concat(issueTime, "</cbc:IssueTime>\n    <cbc:InvoiceTypeCode>SATIS</cbc:InvoiceTypeCode>\n    <cbc:Note>G\u00F6nderim \u015Eekli: ELEKTRONIK</cbc:Note>\n    <cbc:DocumentCurrencyCode>TRY</cbc:DocumentCurrencyCode>\n    <cbc:LineCountNumeric>").concat(invoice.lines.length, "</cbc:LineCountNumeric>\n\n\n\n    <cac:AccountingSupplierParty>\n        <cac:Party>\n            <cac:PartyIdentification>\n                <cbc:ID schemeID=\"VKN\">").concat(supplierVkn || invoice.supplier.vkn, "</cbc:ID>\n            </cac:PartyIdentification>\n            <cac:PartyName>\n                <cbc:Name>").concat(escapeXml(invoice.supplier.name), "</cbc:Name>\n            </cac:PartyName>\n            <cac:PostalAddress>\n                <cbc:CitySubdivisionName>").concat(escapeXml(invoice.supplier.district || ''), "</cbc:CitySubdivisionName>\n                <cbc:CityName>").concat(escapeXml(invoice.supplier.city || ''), "</cbc:CityName>\n                <cac:AddressLine>\n                    <cbc:Line>").concat(escapeXml(invoice.supplier.address || 'ADRES BILGISI YOK'), "</cbc:Line>\n                </cac:AddressLine>\n                <cac:Country>\n                    <cbc:Name>T\u00FCrkiye</cbc:Name>\n                </cac:Country>\n            </cac:PostalAddress>\n            <cac:PartyTaxScheme>\n                <cac:TaxScheme>\n                    <cbc:Name>").concat(escapeXml(invoice.supplier.taxOffice || 'BILINMIYOR'), "</cbc:Name>\n                </cac:TaxScheme>\n            </cac:PartyTaxScheme>\n        </cac:Party>\n    </cac:AccountingSupplierParty>\n    \n    <cac:AccountingCustomerParty>\n        <cac:Party>\n            <cac:PartyIdentification>\n                <cbc:ID schemeID=\"").concat(invoice.customer.vkn.length === 11 ? 'TCKN' : 'VKN', "\">").concat(invoice.customer.vkn, "</cbc:ID>\n            </cac:PartyIdentification>\n            ").concat(invoice.customer.vkn.length === 11 ? "\n            <cac:Person>\n                <cbc:FirstName>".concat(escapeXml(invoice.customer.name.split(' ')[0] || 'BILINMIYOR'), "</cbc:FirstName>\n                <cbc:FamilyName>").concat(escapeXml(invoice.customer.name.split(' ').slice(1).join(' ') || invoice.customer.name.split(' ')[0] || 'BILINMIYOR'), "</cbc:FamilyName>\n            </cac:Person>") : "\n            <cac:PartyName>\n                <cbc:Name>".concat(escapeXml(invoice.customer.name), "</cbc:Name>\n            </cac:PartyName>"), "\n            <cac:PostalAddress>\n                <cbc:CitySubdivisionName>").concat(escapeXml(invoice.customer.district || ''), "</cbc:CitySubdivisionName>\n                <cbc:CityName>").concat(escapeXml(invoice.customer.city || 'İstanbul'), "</cbc:CityName>\n                <cbc:PostalZone>").concat(escapeXml(invoice.customer.postalCode || '34000'), "</cbc:PostalZone>\n                <cac:AddressLine>\n                    <cbc:Line>").concat(escapeXml(invoice.customer.address || 'ADRES BILGISI YOK'), "</cbc:Line>\n                </cac:AddressLine>\n                <cac:Country>\n                    <cbc:Name>T\u00FCrkiye</cbc:Name>\n                </cac:Country>\n            </cac:PostalAddress>\n        </cac:Party>\n    </cac:AccountingCustomerParty>\n\n    <cac:PaymentMeans>\n        <cbc:PaymentMeansCode>1</cbc:PaymentMeansCode>\n        <cbc:Note>").concat(escapeXml(invoice.paymentNote || 'Nakit'), "</cbc:Note>\n        <cbc:PaymentDueDate>").concat(issueDate, "</cbc:PaymentDueDate>\n        <cbc:InstructionNote>").concat(escapeXml(invoice.paymentNote || 'Nakit'), "</cbc:InstructionNote>\n    </cac:PaymentMeans>\n\n    <cac:PaymentTerms>\n        <cbc:Note>").concat(escapeXml(invoice.paymentNote || 'Nakit'), "</cbc:Note>\n    </cac:PaymentTerms>\n\n    <cac:TaxTotal>\n        <cbc:TaxAmount currencyID=\"TRY\">").concat(Number(invoice.totalVat).toFixed(2), "</cbc:TaxAmount>\n        <cac:TaxSubtotal>\n            <cbc:TaxableAmount currencyID=\"TRY\">").concat(Number(invoice.subtotal).toFixed(2), "</cbc:TaxableAmount>\n            <cbc:TaxAmount currencyID=\"TRY\">").concat(Number(invoice.totalVat).toFixed(2), "</cbc:TaxAmount>\n            <cac:TaxCategory>\n                <cac:TaxScheme>\n                    <cbc:ID>0015</cbc:ID>\n                    <cbc:Name>KDV</cbc:Name>\n                    <cbc:TaxTypeCode>0015</cbc:TaxTypeCode>\n                </cac:TaxScheme>\n            </cac:TaxCategory>\n        </cac:TaxSubtotal>\n    </cac:TaxTotal>\n\n    <cac:LegalMonetaryTotal>\n        <cbc:LineExtensionAmount currencyID=\"TRY\">").concat(Number(invoice.subtotal).toFixed(2), "</cbc:LineExtensionAmount>\n        <cbc:TaxExclusiveAmount currencyID=\"TRY\">").concat(Number(invoice.subtotal).toFixed(2), "</cbc:TaxExclusiveAmount>\n        <cbc:TaxInclusiveAmount currencyID=\"TRY\">").concat(Number(invoice.grandTotal).toFixed(2), "</cbc:TaxInclusiveAmount>\n        <cbc:AllowanceTotalAmount currencyID=\"TRY\">0.00</cbc:AllowanceTotalAmount>\n        <cbc:PayableAmount currencyID=\"TRY\">").concat(Number(invoice.grandTotal).toFixed(2), "</cbc:PayableAmount>\n    </cac:LegalMonetaryTotal>\n\n\n    ").concat(invoice.lines.map(function (line, index) { return "\n    <cac:InvoiceLine>\n        <cbc:ID>".concat(index + 1, "</cbc:ID>\n        <cbc:InvoicedQuantity unitCode=\"").concat(line.unit, "\">").concat(line.quantity, "</cbc:InvoicedQuantity>\n        <cbc:LineExtensionAmount currencyID=\"TRY\">").concat((line.quantity * line.price).toFixed(2), "</cbc:LineExtensionAmount>\n        <cac:TaxTotal>\n            <cbc:TaxAmount currencyID=\"TRY\">").concat((line.quantity * line.price * (line.vatRate / 100)).toFixed(2), "</cbc:TaxAmount>\n            <cac:TaxSubtotal>\n                <cbc:TaxableAmount currencyID=\"TRY\">").concat((line.quantity * line.price).toFixed(2), "</cbc:TaxableAmount>\n                <cbc:TaxAmount currencyID=\"TRY\">").concat((line.quantity * line.price * (line.vatRate / 100)).toFixed(2), "</cbc:TaxAmount>\n                <cac:TaxCategory>\n                    <cbc:Percent>").concat(line.vatRate, "</cbc:Percent>\n                    <cac:TaxScheme>\n                        <cbc:ID>0015</cbc:ID>\n                        <cbc:Name>KDV</cbc:Name>\n                        <cbc:TaxTypeCode>0015</cbc:TaxTypeCode>\n                    </cac:TaxScheme>\n                </cac:TaxCategory>\n            </cac:TaxSubtotal>\n        </cac:TaxTotal>\n        <cac:Item>\n            <cbc:Name>").concat(escapeXml(line.name), "</cbc:Name>\n        </cac:Item>\n        <cac:Price>\n            <cbc:PriceAmount currencyID=\"TRY\">").concat(Number(line.price).toFixed(2), "</cbc:PriceAmount>\n        </cac:Price>\n    </cac:InvoiceLine>"); }).join(''), "\n</Invoice>");
};
exports.generateUBL = generateUBL;
